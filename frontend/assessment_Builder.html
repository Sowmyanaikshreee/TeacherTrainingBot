<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Question Paper Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
 
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f8fc;
      min-height: 100vh;
      color: #333;
    }
 
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 240px;
      height: 100vh;
      background: #4a90e2;
      color: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
 
    .sidebar .profile {
      text-align: center;
    }
 
    .profile img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 10px;
      border: 3px solid white;
    }
 
    .profile h3 {
      font-size: 18px;
    }
 
    .profile p {
      font-size: 13px;
      color: #dceeff;
    }
 
    .nav-links {
      margin-top: 30px;
    }
 
    .nav-links a {
      display: block;
      padding: 12px 16px;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 10px;
      font-weight: bold;
      transition: background 0.3s ease;
    }
 
    .nav-links a.active,
    .nav-links a:hover {
      background-color: #ffffff;
      color: #4a90e2;
    }
 
    .bottom-links {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
 
    .btn-link {
      color: white;
      text-decoration: none;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      transition: background 0.3s ease;
    }
 
    .btn-link:hover {
      background-color: #ffffff;
      color: #4a90e2;
    }
 
    .main-content {
      flex: 1;
      margin-left: 240px;
      padding: 40px;
      overflow-y: auto;
      height: 100vh;
    }
 
    .container {
      max-width: 800px;
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      margin: auto;
    }
 
    h2 {
      text-align: center;
      color: #012141;
      margin-bottom: 30px;
      font-size: 28px;
    }
 
    label {
      font-weight: 600;
      display: block;
      margin-top: 20px;
      color: #2c3e50;
    }
 
    select {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      margin-top: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: border 0.3s, box-shadow 0.3s;
    }
 
    select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      outline: none;
    }
 
    .btn-generate {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-weight: 600;
      font-size: 16px;
      border: none;
      cursor: pointer;
      margin-top: 30px;
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      transition: all 0.3s;
    }
 
    .btn-generate:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
 
    .btn-download {
      display: inline-block;
      margin-top: 15px;
      padding: 10px 18px;
      font-size: 15px;
      font-weight: bold;
      background-color: #00a8ff;
      color: #fff;
      border-radius: 8px;
      text-decoration: none;
      transition: background 0.3s, transform 0.3s;
    }
 
    .btn-download:hover {
      background-color: #0097e6;
      transform: scale(1.05);
    }
 
    #previewContainer {
      display: none;
      margin-top: 30px;
    }
 
    #pdfViewer {
      width: 100%;
      height: 500px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
 
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content {
        margin-left: 0;
        padding: 20px;
      }
 
      .container {
        margin: 20px auto;
        padding: 30px 20px;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="profile">
        <img id="profile-photo" src="" alt="User" onerror="this.src='images/Aibot 1.jpg'" />
        <h3 id="profile-name">User Name</h3>
        <p id="profile-grade">Grade</p>
        <p id="profile-subject">Subject</p>
        <p id="profile-email">Email</p>
      </div>
      <div class="nav-links">
        <a href="userHome.html"><i class="fas fa-home"></i> Home</a>
        <a href="ai_chatbot.html"><i class="fas fa-robot"></i> AI Chatbot</a>
        <a href="whiteBoard.html"><i class="fas fa-edit"></i> Whiteboards</a>
      </div>
    </div>
    <div class="bottom-links">
      <a href="profile.html" class="btn-link"><i class="fas fa-user-circle"></i> Profile</a>
      <a href="index.html" class="btn-link"><i class="fas fa-sign-out-alt"></i> Log Out</a>
    </div>
  </aside>
 
  <main class="main-content">
    <div class="container">
      <h2>üßæ Create Your Custom Question Paper</h2>
 
      <label for="fileSelect">Select Uploaded File:</label>
      <select id="fileSelect">
        <option value="">-- Select File --</option>
      </select>
 
      <label>Set Number of Questions Per Category:</label>
 
      <label>MCQ:</label>
      <select id="mcq"><option value="">-- Select --</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
 
      <label>Fill In the Blanks:</label>
      <select id="fill"><option value="">-- Select --</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
 
      <label>Short Answer Question:</label>
      <select id="short"><option value="">-- Select --</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
 
      <label>Long Answer Question:</label>
      <select id="long"><option value="">-- Select --</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
 
      <label for="levelSelect">Select Difficulty Level:</label>
      <select id="levelSelect">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="difficult">Difficult</option>
      </select>
 
      <button class="btn-generate" onclick="generateQuestionPaper()">üöÄ Generate</button>
 
      <div id="loadingMessage" style="display: none; text-align: center; margin-top: 20px;">
        <p style="font-weight: bold; color: #333;">‚è≥ Generating your question paper... Please wait.</p>
      </div>
 
      <div id="previewContainer">
        <h3>üìÑ Preview Generated PDF</h3>
        <iframe id="pdfViewer"></iframe>
        <br>
        <a id="downloadLink" class="btn-download" href="#" download>‚¨áÔ∏è Download PDF</a>
      </div>

      <div id="textPreviewContainer" style="display: none; margin-top: 30px;">
        <h3>üìù Text Version</h3>
        <textarea id="textOutput" rows="15" style="width: 100%; padding: 15px; font-family: monospace; border: 1px solid #ccc; border-radius: 8px;"></textarea>
        <br>
        <a id="downloadTextLink" class="btn-download" href="#" download>‚¨áÔ∏è Download Text</a>
      </div>

      <div id="linkContainer" class="link-section" style="display:none;">
      <h3>üîó Sharable Link</h3>
      <a id="shareableLink" class="btn-link" href="#" target="_blank">Open Question Link</a>
    </div>
     
    </div>

    

    


    </div>
  </main>
 
  <script>
    const email = localStorage.getItem("userEmail") || "";
    const emailSafe = email.replace(/[@.]/g, "_");
    const imageUrl = `http://localhost:8000/profile_photos/${emailSafe}.jpg`;

    document.getElementById("profile-name").innerText = localStorage.getItem("userName") || "User";
    document.getElementById("profile-grade").innerText = "Grade: " + (localStorage.getItem("userGrade") || "-");
    document.getElementById("profile-subject").innerText = "Subject: " + (localStorage.getItem("userSubject") || "-");
    document.getElementById("profile-email").innerText = email || "-";
    document.getElementById("profile-photo").src = imageUrl;

    document.addEventListener("DOMContentLoaded", () => {
      async function loadFiles() {
  const fileSelect = document.getElementById("fileSelect");
  const userGrade = localStorage.getItem("userGrade") || "";
  const userSubject = localStorage.getItem("userSubject") || "";
  const folderKey = `class_${userGrade}/${userSubject}`;

  try {
    const response = await fetch("http://localhost:8000/uploaded_files/");
    const data = await response.json();
    fileSelect.innerHTML = "<option value=''>-- Select File --</option>";

    if (data.files_by_category[folderKey]) {
      data.files_by_category[folderKey].forEach(file => {
        const option = document.createElement("option");
        option.value = `${folderKey}||${file}`;
        option.textContent = `${file}`;
        fileSelect.appendChild(option);
      });
    } else {
      const option = document.createElement("option");
      option.textContent = "No files available for your class and subject.";
      option.disabled = true;
      fileSelect.appendChild(option);
    }
  } catch (err) {
    console.error("Error loading files:", err);
  }
}


      loadFiles();
    });

    async function generateQuestionPaper() {
      const loadingMsg = document.getElementById("loadingMessage");
      loadingMsg.style.display = "block";

      const level = document.getElementById("levelSelect").value;
      const fileValue = document.getElementById("fileSelect").value;
      const [category, file] = fileValue.split("||");

      const counts = {
        mcq: document.getElementById("mcq").value || "0",
        fill: document.getElementById("fill").value || "0",
        short: document.getElementById("short").value || "0",
        long: document.getElementById("long").value || "0",
      };

      const payload = { category, file, level, ...counts };

      try {
        const pdfRes = await fetch("http://localhost:8000/generate_pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!pdfRes.ok) {
          alert("Failed to generate question paper PDF.");
          loadingMsg.style.display = "none";
          return;
        }

        const pdfBlob = await pdfRes.blob();
        const pdfUrl = URL.createObjectURL(pdfBlob);
        document.getElementById("pdfViewer").src = pdfUrl;
        document.getElementById("downloadLink").href = pdfUrl;
        document.getElementById("downloadLink").download = `Question_Paper_${category}.pdf`;
        document.getElementById("previewContainer").style.display = "block";

        const textRes = await fetch("http://localhost:8000/generate_text", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const textData = await textRes.json();
        const textOutput = textData.text || "No text output available.";
        document.getElementById("textOutput").value = textOutput;
        document.getElementById("textPreviewContainer").style.display = "block";

        const textBlob = new Blob([textOutput], { type: "text/plain" });
        const textUrl = URL.createObjectURL(textBlob);
        document.getElementById("downloadTextLink").href = textUrl;
        document.getElementById("downloadTextLink").download = `Question_Paper_${category}.txt`;

      } catch (err) {
        console.error("Error:", err);
        alert("An error occurred during generation.");
      } finally {
        loadingMsg.style.display = "none";
      }
      
}
    
  </script>
</body>
</html>